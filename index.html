<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Portfolio Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" defer></script>

    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
        }
        html, body, #root {
            min-height: 100vh;
        }
        .critical-error-message {
            color: #ef4444; 
            background-color: #fee2e2; 
            border: 2px solid #f87171; 
            text-align: center; 
            padding: 20px;
            margin: 20px auto;
            border-radius: 8px;
            max-width: 800px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .critical-error-message h1 {
            font-size: 1.75rem; 
            font-weight: bold;
            color: #b91c1c; 
            margin-bottom: 1rem; 
        }
         .critical-error-message code {
            background-color: #fecaca; 
            padding: 3px 6px; 
            border-radius: 4px;
            font-family: monospace;
            color: #991b1b; 
            font-size: 0.95em;
        }
        .critical-error-message p {
            margin-bottom: 0.75rem; 
            line-height: 1.6; 
            color: #7f1d1d; 
        }
        .critical-error-message strong {
            color: #991b1b; 
        }
        .critical-error-message ol {
            text-align: left;
            display: inline-block;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-left: 25px; 
        }
        .critical-error-message ol li {
            margin-bottom: 0.5rem;
        }
        .chart-container svg { 
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .pie-chart-slice {
            stroke-width: 0; 
            cursor: default; 
        }
        .bar-graph-bar {
            transition: fill 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .bar-graph-bar:hover {
            opacity: 0.8;
        }
        .bar-graph-axis, .line-graph-axis { /* Combined for consistency */
            stroke: #475569; 
            stroke-width: 1;
        }
        .bar-graph-text, .line-graph-text { /* Combined for consistency */
            font-size: 10px;
            fill: #94a3b8; 
        }
        .bar-graph-grid-line {
            stroke: #334155; /* slate-700 for subtle grid */
            stroke-width: 0.5px;
            stroke-dasharray: 2 2;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root">
        {/* Initial loading message */}
    </div>

    <script type="text/babel"> 
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyChmrmY4JLB_Q6-DkZmg6-RHwX7KfKuIqA",
            authDomain: "test-project-9f890.firebaseapp.com",
            projectId: "test-project-9f890",
            storageBucket: "test-project-9f890.appspot.com", 
            messagingSenderId: "498848587964",
            appId: "1:498848587964:web:19094e0fd3f29d178330b9"
        };
        
        const FIRESTORE_APP_ID_NAMESPACE = 'my-standalone-portfolio'; 

        const ALPHA_VANTAGE_API_KEYS = ['1D3WOJQHDQFYU46K', '4BBZHJK57IBM6Z94'];
        const ALPHA_VANTAGE_BASE_URL = 'https://www.alphavantage.co/query';

        let app;
        let auth;
        let db;
        let firebaseAuthPersistencePromise; 

        try {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_") || 
                !firebaseConfig.projectId || firebaseConfig.projectId.includes("YOUR_")) {
                 throw new Error("Firebase configuration appears to be using placeholder or incomplete values. Please verify all fields in `firebaseConfig` with your actual Firebase project credentials for a WEB APP.");
            }

            if (!firebase.apps.length) {
                 app = firebase.initializeApp(firebaseConfig);
            } else {
                 app = firebase.app(); 
            }
            auth = firebase.auth();
            db = firebase.firestore();

            firebaseAuthPersistencePromise = auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log("Firebase auth persistence set to LOCAL.");
                })
                .catch((error) => {
                    console.error("Error setting Firebase auth persistence:", error);
                });

        } catch (error) {
            console.error("CRITICAL: Error initializing Firebase:", error);
            const rootDiv = document.getElementById('root');
            if (rootDiv) {
                rootDiv.innerHTML = `
                    <div class="critical-error-message">
                        <h1>Firebase Initialization Error</h1>
                        <p>${error.message}</p>
                        <p><strong>Action Required:</strong> Please verify your <code>firebaseConfig</code> object in the script with the values from your Firebase project console. Ensure all fields are correct and that the Firebase project (<code>${firebaseConfig.projectId || "unknown"}</code>) is properly set up.</p>
                    </div>`;
            }
            throw new Error("Halting script execution due to Firebase initialization failure. Please fix the firebaseConfig."); 
        }

        const IconPlaceholder = ({ text, className = "" }) => <span className={`inline-block px-1 ${className}`}>{text}</span>;
        const PlusCircle = () => <IconPlaceholder text="[+]" className="text-green-400" />;
        const Trash2 = () => <IconPlaceholder text="[Del]" className="text-red-400" />;
        const Edit3 = () => <IconPlaceholder text="[Edit]" className="text-blue-400" />;
        const RefreshCw = () => <IconPlaceholder text="[Refr]" />;
        const LogOut = () => <IconPlaceholder text="[Logout]" className="text-red-400" />;
        const TrendingUp = () => <IconPlaceholder text="[â–²]" className="text-green-400" />;
        const TrendingDown = () => <IconPlaceholder text="[â–¼]" className="text-red-400" />;
        const DollarSign = () => <IconPlaceholder text="[$]" className="text-blue-400" />;
        const Briefcase = () => <IconPlaceholder text="[ðŸ’¼]" className="text-indigo-400" />;
        const Info = () => <IconPlaceholder text="[i]" className="text-blue-300" />;
        const XCircle = () => <IconPlaceholder text="[X]" className="text-gray-400" />;
        const DownloadCloud = () => <IconPlaceholder text="[â†“]" />;
        const AlertTriangle = () => <IconPlaceholder text="[âš ï¸]" className="text-yellow-400" />;
        const LogInIcon = () => <IconPlaceholder text="[Login]" />;
        const PieChartIcon = () => <IconPlaceholder text="[ðŸ“Š]" />;
        const ListIcon = () => <IconPlaceholder text="[â˜°]" />;
        const BarChartIcon = () => <IconPlaceholder text="[|||]" />;


        const formatCurrency = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return 'â‚¹0.00';
            return `â‚¹${amount.toFixed(2)}`;
        };
        const formatPercentage = (percentage) => {
            if (typeof percentage !== 'number' || isNaN(percentage)) return '0.00%';
            return `${percentage.toFixed(2)}%`;
        };
        const formatDate = (timestamp, options = {}) => {
            if (!timestamp) return 'N/A';
            try {
                let date;
                if (timestamp.seconds) { 
                    date = new Date(timestamp.seconds * 1000);
                } else if (timestamp instanceof Date) { 
                    date = timestamp;
                } else if (typeof timestamp === 'object' && timestamp._seconds) { 
                    date = new Date(timestamp._seconds * 1000);
                } else {
                    return 'Invalid Date';
                }
                return date.toLocaleString(undefined, options);
            } catch (e) { console.warn("Error formatting date:", timestamp, e); }
            return 'Invalid Date';
        };

        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <h3 className="text-xl font-semibold text-sky-400 mb-4">{title}</h3>
                        <p className="text-slate-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            <button onClick={onCancel} className="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-slate-200 font-medium rounded-lg shadow-sm transition-colors">Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-sm transition-colors">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthForm = ({ onAuthSuccess }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [authLoading, setAuthLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault(); setAuthError(''); setAuthLoading(true);
                if (!auth) { setAuthError("Firebase Auth not initialized."); setAuthLoading(false); return; }
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) { console.error("Login error:", err); setAuthError(err.message);
                } finally { setAuthLoading(false); }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 p-4">
                    <div className="w-full max-w-md p-8 space-y-6 bg-slate-800 rounded-xl shadow-2xl">
                        <h2 className="text-3xl font-bold text-center text-sky-400">Login to Portfolio</h2>
                        {authError && <p className="text-red-400 bg-red-900/50 p-3 rounded-md text-sm text-center">{authError}</p>}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-slate-300">Email address</label>
                                <input id="email" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)}
                                    className="mt-1 block w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                    placeholder="you@example.com" />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-slate-300">Password</label>
                                <input id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 block w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                            </div>
                            <div>
                                <button type="submit" disabled={authLoading}
                                    className="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 focus:ring-offset-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"
                                >
                                    {authLoading ? <RefreshCw className="animate-spin h-5 w-5 mr-2" /> : <LogInIcon className="h-5 w-5 mr-2" />}
                                    {authLoading ? 'Processing...' : 'Sign In'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUserState] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false); 
            const [holdings, setHoldings] = useState([]);
            const [isLoading, setIsLoading] = useState(true); 
            const [isFetchingPrices, setIsFetchingPrices] = useState(false);
            const [showAddForm, setShowAddForm] = useState(false);
            const [editingHolding, setEditingHolding] = useState(null);
            const [error, setError] = useState(null);
            const [info, setInfo] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [holdingToDelete, setHoldingToDelete] = useState(null);
            const [lastPriceUpdateAttempt, setLastPriceUpdateAttempt] = useState(null);
            const apiKeyIndexRef = useRef(0);
            const [currentView, setCurrentView] = useState('portfolio'); 
            const [portfolioHistory, setPortfolioHistory] = useState([]);

            useEffect(() => {
                if (!auth) { 
                     setError("Firebase Auth service is not available. App cannot function.");
                    setIsAuthReady(true); setIsLoading(false); return;
                }
                let unsubscribeAuthListener;
                Promise.resolve(firebaseAuthPersistencePromise).finally(() => {
                    unsubscribeAuthListener = auth.onAuthStateChanged(async (currentUser) => {
                        setUserState(currentUser); 
                        setUserId(currentUser ? currentUser.uid : null);
                        setIsAuthReady(true); 
                        if (!currentUser) setIsLoading(false); 
                    });
                });
                return () => { if (unsubscribeAuthListener) unsubscribeAuthListener(); };
            }, []); 

            useEffect(() => {
                if (!isAuthReady) return; 
                if (!userId) { setHoldings([]); setPortfolioHistory([]); setIsLoading(false); return; }
                if (!db) { setError("Firestore database service is not available."); setIsLoading(false); return; }
                
                setIsLoading(true); 
                let unsubHoldings, unsubHistory;

                const holdingsCollectionPath = `artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`;
                const qHoldings = db.collection(holdingsCollectionPath); 
                unsubHoldings = qHoldings.onSnapshot((querySnapshot) => {
                    const holdingsData = [];
                    querySnapshot.forEach((doc) => holdingsData.push({ id: doc.id, ...doc.data() }));
                    setHoldings(holdingsData);
                    if (portfolioHistory.length > 0 || querySnapshot.empty) {
                         // setIsLoading(false); // Potentially defer this
                    }
                    setError(null);
                }, (err) => {
                    console.error("Error fetching holdings:", err);
                    setError(`Failed to load portfolio: ${err.message}.`); setIsLoading(false);
                });

                const historyCollectionPath = `artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/portfolioHistory`;
                const qHistory = db.collection(historyCollectionPath).orderBy("timestamp", "asc").limit(30); 
                unsubHistory = qHistory.onSnapshot((querySnapshot) => {
                    const historyData = [];
                    querySnapshot.forEach((doc) => historyData.push({ id: doc.id, ...doc.data() }));
                    setPortfolioHistory(historyData);
                    setIsLoading(false); // Both subscriptions are set up or have fired.
                }, (err) => {
                    console.error("Error fetching portfolio history:", err);
                    setIsLoading(false); 
                });

                return () => { 
                    if (unsubHoldings) unsubHoldings(); 
                    if (unsubHistory) unsubHistory();
                };
            }, [isAuthReady, userId]); 

            const portfolioSummary = useMemo(() => {
                let ti=0, tcv=0; holdings.forEach(h => { ti+=(h.quantity||0)*(h.purchasePrice||0); tcv+=(h.quantity||0)*(h.currentPrice||0);});
                const tr=tcv-ti; const trp=ti!==0?(tr/ti)*100:0;
                return { totalInvestment:ti, totalCurrentValue:tcv, totalReturns:tr, totalReturnsPercentage:trp };
            }, [holdings]);

            const handleSaveHolding = async (holdingData) => {
                if (!db || !userId) { setError("Database not available."); return; }
                const holdingPayload = {
                    symbol: holdingData.symbol.toUpperCase().trim(), name: holdingData.name.trim(),
                    quantity: parseFloat(holdingData.quantity), purchasePrice: parseFloat(holdingData.purchasePrice),
                };
                if (editingHolding && holdingData.id) { 
                    try {
                        const docRef = db.collection(`artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`).doc(holdingData.id);
                        await docRef.update({ name: holdingPayload.name, quantity: holdingPayload.quantity, purchasePrice: holdingPayload.purchasePrice });
                        setInfo(`Holding ${holdingPayload.symbol} updated.`);
                    } catch (e) { setError(`Update failed: ${e.message}`); }
                } else { 
                    try {
                        const collRef = db.collection(`artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`);
                        await collRef.add({ ...holdingPayload, currentPrice: holdingPayload.purchasePrice, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        setInfo(`Holding ${holdingPayload.symbol} added.`);
                    } catch (e) { setError(`Add failed: ${e.message}`);}
                }
                setShowAddForm(false); setEditingHolding(null); 
            };

            const handleEditHolding = (h) => { setEditingHolding(h); setShowAddForm(true); };
            const handleCancelEdit = () => { setShowAddForm(false); setEditingHolding(null); };
            const requestDeleteHolding = (id) => { setHoldingToDelete(id); setShowDeleteConfirm(true); };
            const confirmDeleteHolding = async () => {
                if (!db || !userId || !holdingToDelete) { setError("Cannot delete."); setShowDeleteConfirm(false); return; }
                try {
                    await db.collection(`artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`).doc(holdingToDelete).delete();
                    setInfo("Holding deleted.");
                } catch (e) { setError(`Delete failed: ${e.message}`); }
                finally { setShowDeleteConfirm(false); setHoldingToDelete(null); }
            };
            
            const fetchEodPriceForHolding = async (holding, apiKeyToUse) => {
                const baseSymbol = holding.symbol.toUpperCase();
                const suffixesToTry = ['.NS', '.BSE']; let lastFetchError = null;
                for (const suffix of suffixesToTry) {
                    const symbolWithExchange = `${baseSymbol}${suffix}`;
                    const url = `${ALPHA_VANTAGE_BASE_URL}?function=TIME_SERIES_DAILY&symbol=${symbolWithExchange}&apikey=${apiKeyToUse}`;
                    try {
                        setInfo(`Fetching for ${symbolWithExchange}...`);
                        const resp = await fetch(url); const txt = await resp.text();
                        if (!resp.ok) { lastFetchError = new Error(`API req for ${symbolWithExchange} fail (${resp.status}).`); console.warn(lastFetchError.message, txt.substring(0,100)); if (resp.status === 404) continue; continue;}
                        const data = JSON.parse(txt);
                        if (data['Error Message']) { lastFetchError = new Error(`API Error for ${symbolWithExchange}: ${data['Error Message']}`); console.warn(lastFetchError.message); continue; }
                        if (data['Note'] || data['Information']) { console.warn(`API Note/Info for ${symbolWithExchange}: ${data['Note'] || data['Information']}`); setInfo(`API Note for ${symbolWithExchange}: ${data['Note'] || data['Information']}.`);}
                        const ts = data['Time Series (Daily)'];
                        if (!ts || Object.keys(ts).length === 0) { lastFetchError = new Error(`No time series for ${symbolWithExchange}.`); console.warn(lastFetchError.message, JSON.stringify(data).substring(0,200)); continue; }
                        const date = Object.keys(ts)[0];
                        if (!date || !ts[date] || !ts[date]['4. close']) { lastFetchError = new Error(`Could not parse for ${symbolWithExchange} on ${date}.`); console.warn(lastFetchError.message); continue; }
                        const price = parseFloat(ts[date]['4. close']);
                        if (isNaN(price)) { lastFetchError = new Error(`Parsed price for ${symbolWithExchange} is NaN.`); console.warn(lastFetchError.message); continue; }
                        const docRef = db.collection(`artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`).doc(holding.id);
                        await docRef.update({ currentPrice: price, lastPriceUpdate: firebase.firestore.FieldValue.serverTimestamp(), fetchedSymbol: symbolWithExchange });
                        return { success: true, symbol: baseSymbol };
                    } catch (e) { lastFetchError = e; console.error(`Fetch error for ${symbolWithExchange}:`, e); }
                }
                console.error(`All attempts for ${baseSymbol} failed. Last: ${lastFetchError ? lastFetchError.message : 'Unknown'}.`);
                return { success: false, symbol: baseSymbol, error: lastFetchError ? lastFetchError.message : 'Unknown' };
            };

            const handleRefreshAllEodPrices = async () => {
                if (!db || !userId || holdings.length === 0) { setInfo("No holdings to refresh."); return; }
                setIsFetchingPrices(true); setError(null); 
                setInfo(`Refreshing prices for ${holdings.length} holdings...`);
                setLastPriceUpdateAttempt(new Date());
                let sC=0, eC=0; let errMsgs=[];
                
                const priceUpdatePromises = holdings.map((h, i) => {
                    return new Promise(async (resolve) => {
                        if (i > 0) { 
                            const delay = 10000; 
                            setInfo(`Waiting ${delay/1000}s... (${i}/${holdings.length} processed)`);
                            await new Promise(r => setTimeout(r, delay));
                        }
                        const key = ALPHA_VANTAGE_API_KEYS[apiKeyIndexRef.current];
                        apiKeyIndexRef.current = (apiKeyIndexRef.current + 1) % ALPHA_VANTAGE_API_KEYS.length;
                        const res = await fetchEodPriceForHolding(h, key);
                        resolve(res);
                    });
                });

                const results = await Promise.all(priceUpdatePromises);
                results.forEach(res => {
                    if (res.success) sC++;
                    else { eC++; if(res.error) errMsgs.push(`${res.symbol}: ${res.error.substring(0,100)}...`);}
                });
                
                setTimeout(async () => { 
                    let currentTotalValue = 0;
                    let currentTotalInvestment = 0;
                    const updatedHoldingsSnapshot = await db.collection(`artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/holdings`).get();
                    const currentHoldingsData = [];
                    updatedHoldingsSnapshot.forEach(doc => currentHoldingsData.push(doc.data()));

                    currentHoldingsData.forEach(h => {
                        currentTotalValue += (h.quantity || 0) * (h.currentPrice || 0);
                        currentTotalInvestment += (h.quantity || 0) * (h.purchasePrice || 0);
                    });

                    if (sC > 0 && userId && currentTotalValue > 0) { 
                        try {
                            const historyCollectionPath = `artifacts/${FIRESTORE_APP_ID_NAMESPACE}/users/${userId}/portfolioHistory`;
                            await db.collection(historyCollectionPath).add({
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                totalPortfolioValue: currentTotalValue,
                                totalInvestment: currentTotalInvestment 
                            });
                            console.log("Portfolio history snapshot saved.");
                        } catch (historyError) {
                            console.error("Error saving portfolio history:", historyError);
                        }
                    }
                    let sumMsg = `Refresh: ${sC} ok, ${eC} fail.`; if (eC>0) setError(`${eC} stock(s) failed. ${errMsgs[0]||''} See console.`);
                    setInfo(sumMsg); setIsFetchingPrices(false);
                }, 2500);

            };

            const handleLogout = async () => { if (!auth) return; try { await auth.signOut(); } catch (e) { setError(`Logout fail: ${e.message}`);}};
            
            if (!isAuthReady || isLoading) {
                let msg="Initializing...";
                if(isAuthReady && isLoading && !userId && auth) msg="Authenticating...";
                else if(isAuthReady && isLoading && userId) msg="Loading portfolio...";
                return <LoadingSpinner message={msg} />;
            }
            if (!auth || !db) return <div className="critical-error-message"><h1>App Error</h1><p>Firebase not available.</p></div>;
            if (!user) return <AuthForm />;
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-slate-100 p-4 sm:p-6 md:p-8 font-['Inter',_sans-serif]">
                    <ConfirmationModal isOpen={showDeleteConfirm} title="Confirm Deletion" message="Are you sure?" onConfirm={confirmDeleteHolding} onCancel={() => { setShowDeleteConfirm(false); setHoldingToDelete(null); }} />
                    <div className="container mx-auto max-w-7xl"> 
                        <header className="mb-8 flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-slate-700">
                            <h1 className="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 via-cyan-400 to-teal-400 mb-4 sm:mb-0">
                                Share Portfolio Tracker
                            </h1>
                            <div className="flex items-center space-x-4">
                                {user && <span className="text-sm px-4 py-2 bg-slate-700 rounded-full shadow-md">Logged in as: <span className="font-semibold text-sky-300">{user.email || userId.substring(0,12) + '...'}</span></span>}
                                <button 
                                    onClick={handleLogout} 
                                    className="p-2 bg-red-600 hover:bg-red-500 text-white rounded-full shadow-lg transition-all duration-150 ease-in-out transform hover:scale-105" 
                                    title="Logout">
                                    <LogOut />
                                </button>
                            </div>
                        </header>

                        <div className="mb-8 flex justify-center sm:justify-start space-x-2 border-b border-slate-700 pb-3">
                            <button 
                                onClick={() => setCurrentView('portfolio')} 
                                className={`flex items-center space-x-2 px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-150 ease-in-out
                                            ${currentView === 'portfolio' 
                                                ? 'bg-sky-500 text-white shadow-lg ring-2 ring-sky-400 ring-offset-2 ring-offset-slate-900' 
                                                : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}> 
                                <ListIcon /> <span>Portfolio</span>
                            </button>
                            <button 
                                onClick={() => setCurrentView('dashboard')} 
                                className={`flex items-center space-x-2 px-5 py-2.5 rounded-lg font-medium text-sm transition-all duration-150 ease-in-out
                                            ${currentView === 'dashboard' 
                                                ? 'bg-sky-500 text-white shadow-lg ring-2 ring-sky-400 ring-offset-2 ring-offset-slate-900' 
                                                : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}> 
                                <PieChartIcon /> <span>Dashboard</span>
                            </button>
                        </div>

                        {error && <ErrorMessage message={error} onClose={() => setError(null)} />}
                        {info && <InfoMessage message={info} onClose={() => setInfo(null)} />}
                        
                        {currentView === 'portfolio' && (
                            <div className="animate-fadeIn">
                                <div className="my-4 p-4 bg-slate-800/50 border border-slate-700 rounded-lg text-slate-300 text-sm flex items-center space-x-3 shadow">
                                    <AlertTriangle className="text-yellow-400 h-6 w-6 shrink-0"/>
                                    <p>
                                        Prices are EOD from Alpha Vantage. 
                                        <span className="font-semibold">{ALPHA_VANTAGE_API_KEYS.length} API key(s)</span> are used in rotation. Updates are manual and rate-limited. App attempts `SYMBOL.NS` then `SYMBOL.BSE`.
                                        {lastPriceUpdateAttempt && <span className="block mt-1">Last price refresh attempt: {formatDate(lastPriceUpdateAttempt)}.</span>}
                                    </p>
                                </div>
                                <PortfolioSummaryCards summary={portfolioSummary} />
                                <div className="my-8 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                     <button 
                                        onClick={() => { setShowAddForm(true); setEditingHolding(null); }} 
                                        className="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out transform hover:scale-105"> 
                                        <PlusCircle className="mr-2 h-5 w-5" /> Add New Holding 
                                    </button>
                                    <button 
                                        onClick={handleRefreshAllEodPrices} 
                                        disabled={isFetchingPrices || holdings.length === 0} 
                                        className="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out transform hover:scale-105 disabled:opacity-60 disabled:cursor-not-allowed">
                                        {isFetchingPrices ? <RefreshCw className="mr-2 h-5 w-5 animate-spin" /> : <DownloadCloud className="mr-2 h-5 w-5" />}
                                        {isFetchingPrices ? 'Fetching Prices...' : 'Refresh All Prices'}
                                    </button>
                                </div>
                                {showAddForm && <AddHoldingForm onSubmit={handleSaveHolding} onCancel={handleCancelEdit} initialData={editingHolding} />}
                                {!isLoading && !holdings.length && !showAddForm && userId && ( 
                                     <div className="mt-12 text-center p-10 bg-slate-800 rounded-xl shadow-xl border border-slate-700 animate-pulseSlow"> 
                                        <Briefcase className="mx-auto h-20 w-20 text-sky-500 mb-6" /> 
                                        <h2 className="text-3xl font-semibold text-slate-200 mb-4">Your Portfolio is Empty</h2> 
                                        <p className="text-slate-400 mb-8 text-lg">Click "Add New Holding" to start tracking your investments.</p> 
                                    </div>
                                )}
                                {holdings.length > 0 && <HoldingsTable holdings={holdings} onDelete={requestDeleteHolding} onEdit={handleEditHolding} />}
                            </div>
                        )}
                        {currentView === 'dashboard' && <DashboardView holdings={holdings} portfolioSummary={portfolioSummary} portfolioHistory={portfolioHistory} />}
                        
                        <footer className="mt-16 pt-8 border-t border-slate-700 text-center text-sm text-slate-500">
                            <p>&copy; {new Date().getFullYear()} Portfolio Tracker. Namespace: <span className="font-mono">{FIRESTORE_APP_ID_NAMESPACE}</span></p>
                        </footer>
                    </div>
                </div>
            );
        }

        const PortfolioSummaryCards = ({ summary }) => { 
            const { totalInvestment, totalCurrentValue, totalReturns, totalReturnsPercentage } = summary;
            const isProfit = totalReturns >= 0;
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 sm:gap-6 mb-8">
                    <SummaryCard title="Total Investment" value={formatCurrency(totalInvestment)} icon={<DollarSign className="text-blue-400 h-6 w-6" />} />
                    <SummaryCard title="Current Value (EOD)" value={formatCurrency(totalCurrentValue)} icon={<Briefcase className="text-green-400 h-6 w-6" />} />
                    <SummaryCard title="Total P/L" value={formatCurrency(totalReturns)} icon={isProfit ? <TrendingUp className="text-emerald-400 h-6 w-6" /> : <TrendingDown className="text-red-400 h-6 w-6" />} valueColor={isProfit ? "text-emerald-400" : "text-red-400"} />
                    <SummaryCard title="Total P/L %" value={formatPercentage(totalReturnsPercentage)} icon={isProfit ? <TrendingUp className="text-emerald-400 h-6 w-6" /> : <TrendingDown className="text-red-400 h-6 w-6" />} valueColor={isProfit ? "text-emerald-400" : "text-red-400"} />
                </div>
            );
        };
        const SummaryCard = ({ title, value, icon, valueColor = "text-slate-100" }) => ( 
            <div className="bg-slate-800 p-6 rounded-xl shadow-lg hover:shadow-sky-500/30 transition-all duration-300 ease-in-out transform hover:-translate-y-1 border border-slate-700">
                <div className="flex items-center justify-between mb-3"> <h3 className="text-base font-medium text-slate-400">{title}</h3> {icon && React.isValidElement(icon) && <div className="p-2.5 bg-slate-700 rounded-full">{icon}</div>} </div>
                <p className={`text-3xl font-bold ${valueColor}`}>{value}</p>
            </div>
        );
        const AddHoldingForm = ({ onSubmit, onCancel, initialData }) => { 
            const [symbol, setSymbol] = useState(''); const [name, setName] = useState('');
            const [quantity, setQuantity] = useState(''); const [purchasePrice, setPurchasePrice] = useState('');
            const [formError, setFormError] = useState(''); const isEditMode = Boolean(initialData);
            useEffect(() => {
                if (isEditMode && initialData) {
                    setSymbol(initialData.symbol || ''); setName(initialData.name || '');
                    setQuantity(initialData.quantity !== undefined ? String(initialData.quantity) : '');
                    setPurchasePrice(initialData.purchasePrice !== undefined ? String(initialData.purchasePrice) : '');
                } else { setSymbol(''); setName(''); setQuantity(''); setPurchasePrice(''); }
            }, [initialData, isEditMode]);
            const handleSubmit = (e) => {
                e.preventDefault(); setFormError('');
                if (!symbol.trim()||!name.trim()||!quantity||!purchasePrice) { setFormError('All fields are required.'); return; }
                const nQ=parseFloat(quantity); const nPP=parseFloat(purchasePrice);
                if (isNaN(nQ)||nQ<=0) { setFormError('Quantity must be > 0.'); return; }
                if (isNaN(nPP)||nPP<=0) { setFormError('Purchase price must be > 0.'); return; }
                onSubmit({ id:isEditMode?initialData.id:undefined, symbol, name, quantity:nQ, purchasePrice:nPP });
            };
            return ( <div className="my-8 p-6 sm:p-8 bg-slate-800 rounded-xl shadow-2xl border border-slate-700"> <h2 className="text-2xl font-semibold mb-6 text-sky-400">{isEditMode ? 'Edit Holding' : 'Add New Stock Holding'}</h2> {formError && <p className="text-red-400 bg-red-900/50 p-3 rounded-md mb-4 text-sm">{formError}</p>} <form onSubmit={handleSubmit} className="space-y-5"> <div className="grid grid-cols-1 md:grid-cols-2 gap-5"> <div> <label htmlFor="symbol" className="block text-sm font-medium text-slate-300 mb-1">Stock Symbol</label> <input type="text" id="symbol" value={symbol} readOnly={isEditMode} onChange={(e)=>!isEditMode&&setSymbol(e.target.value)} required className={`w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg outline-none ${isEditMode ? 'cursor-not-allowed opacity-70' : 'focus:ring-2 focus:ring-sky-500'}`} /> </div><div> <label htmlFor="name" className="block text-sm font-medium text-slate-300 mb-1">Stock Name</label> <input type="text" id="name" value={name} onChange={(e)=>setName(e.target.value)} required className="w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 outline-none" /> </div><div> <label htmlFor="quantity" className="block text-sm font-medium text-slate-300 mb-1">Quantity</label> <input type="number" id="quantity" value={quantity} onChange={(e)=>setQuantity(e.target.value)} required min="0.0001" step="any" className="w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 outline-none" /> </div><div> <label htmlFor="purchasePrice" className="block text-sm font-medium text-slate-300 mb-1">Purchase Price</label> <input type="number" id="purchasePrice" value={purchasePrice} onChange={(e)=>setPurchasePrice(e.target.value)} required min="0.01" step="any" className="w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 outline-none" /> </div></div><div className="flex justify-end space-x-4 pt-3"> <button type="button" onClick={onCancel} className="px-6 py-2.5 bg-slate-600 hover:bg-slate-500 text-slate-200 font-medium rounded-lg shadow-sm transition-colors">Cancel</button> <button type="submit" className="px-6 py-2.5 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg shadow-sm transition-colors">{isEditMode ? 'Update Holding' : 'Add Holding'}</button> </div></form> </div> );
        };
        const HoldingsTable = ({ holdings, onDelete, onEdit }) => { 
            if (!holdings || holdings.length === 0) return null;
            return ( <div className="mt-8 bg-slate-800 shadow-xl rounded-xl overflow-hidden border border-slate-700"> <div className="overflow-x-auto"> <table className="w-full min-w-max text-sm text-left text-slate-300"><thead className="text-xs text-sky-300 uppercase bg-slate-700/50"><tr>
                {['Symbol', 'Fetched As', 'Name', 'Qty', 'Buy Price', 'EOD Price', 'Last Update', 'Investment', 'Current Value', 'P/L', 'P/L %', 'Actions'].map(header => ( <th key={header} scope="col" className="px-5 py-4 whitespace-nowrap font-semibold tracking-wider">{header}</th> ))}
            </tr></thead><tbody className="divide-y divide-slate-700">
                {holdings.map((h) => { const qty = h.quantity||0, pp=h.purchasePrice||0, cp=h.currentPrice||0; const invVal=qty*pp, currVal=qty*cp; const pl=currVal-invVal; const plp=invVal!==0?(pl/invVal)*100:0; const isProfit = pl >= 0; return ( <tr key={h.id} className="hover:bg-slate-700/70 transition-colors duration-150"> <td className="px-5 py-4 font-medium text-sky-400">{h.symbol}</td> <td className="px-5 py-4 text-xs text-slate-400">{h.fetchedSymbol||'N/A'}</td> <td className="px-5 py-4">{h.name}</td> <td className="px-5 py-4 text-right">{qty.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:4})}</td> <td className="px-5 py-4 text-right">{formatCurrency(pp)}</td> <td className="px-5 py-4 text-right font-semibold">{formatCurrency(cp)}</td> <td className="px-5 py-4 text-xs">{h.lastPriceUpdate?formatDate(h.lastPriceUpdate):'N/A'}</td> <td className="px-5 py-4 text-right">{formatCurrency(invVal)}</td> <td className="px-5 py-4 text-right font-semibold">{formatCurrency(currVal)}</td> <td className={`px-5 py-4 text-right font-semibold ${isProfit?'text-emerald-400':'text-red-400'}`}>{formatCurrency(pl)}</td> <td className={`px-5 py-4 text-right font-semibold ${isProfit?'text-emerald-400':'text-red-400'}`}>{formatPercentage(plp)}</td> <td className="px-5 py-4 text-center space-x-2"> <button onClick={()=>onEdit(h)} title="Edit" className="p-2 text-blue-400 hover:text-blue-300 hover:bg-slate-700 rounded-full transition-colors"><Edit3 className="h-5 w-5"/></button> <button onClick={()=>onDelete(h.id)} title="Delete" className="p-2 text-red-500 hover:text-red-400 hover:bg-slate-700 rounded-full transition-colors"><Trash2 className="h-5 w-5"/></button> </td> </tr> ); })}
            </tbody></table> </div> </div> );
        };
        const LoadingSpinner = ({ message="Loading..." }) => ( <div className="flex flex-col items-center justify-center text-center p-10 bg-slate-800 rounded-xl shadow-lg my-8"> <svg className="animate-spin h-12 w-12 text-sky-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <p className="text-lg font-medium text-slate-300">{message}</p> </div> );
        const ErrorMessage = ({ message, onClose }) => ( <div className="bg-red-700/80 border border-red-600 text-red-100 px-4 py-3 rounded-lg relative mb-6 shadow-lg backdrop-blur-sm"> <div className="flex items-center"><XCircle className="h-5 w-5 mr-3 text-red-300 shrink-0"/><div><strong className="font-semibold">Error: </strong><span className="block sm:inline">{message}</span></div></div> <button onClick={onClose} className="absolute top-2.5 right-2.5 p-1 text-red-300 hover:text-red-100 transition-colors" title="Close"><XCircle className="h-5 w-5"/></button> </div> );
        const InfoMessage = ({ message, onClose }) => ( <div className="bg-sky-700/80 border border-sky-600 text-sky-100 px-4 py-3 rounded-lg relative mb-6 shadow-lg backdrop-blur-sm"> <div className="flex items-center"><Info className="h-5 w-5 mr-3 text-sky-300 shrink-0"/><div><strong className="font-semibold">Info: </strong><span className="block sm:inline">{message}</span></div></div> <button onClick={onClose} className="absolute top-2.5 right-2.5 p-1 text-sky-300 hover:text-sky-100 transition-colors" title="Close"><XCircle className="h-5 w-5"/></button> </div> );

        // --- Dashboard Component ---
        const DashboardView = ({ holdings, portfolioSummary, portfolioHistory }) => {
            if (!holdings || holdings.length === 0) {
                return <div className="mt-10 text-center p-10 bg-slate-800 rounded-xl shadow-xl border border-slate-700"><Briefcase className="mx-auto h-20 w-20 text-sky-500 mb-6" /><h2 className="text-3xl font-semibold text-slate-200 mb-4">Dashboard is Empty</h2><p className="text-slate-400 text-lg">Add some holdings to see your portfolio statistics and charts.</p></div>;
            }

            const processedHoldings = holdings.map(h => {
                const investment = (h.quantity || 0) * (h.purchasePrice || 0);
                const currentValue = (h.quantity || 0) * (h.currentPrice || 0);
                const pnl = currentValue - investment;
                return { ...h, investment, currentValue, pnl };
            });

            const bestPerformer = processedHoldings.length > 0 ? processedHoldings.reduce((best, current) => (current.pnl > best.pnl ? current : best), processedHoldings[0]) : {pnl: 0, symbol: 'N/A'};
            const worstPerformer = processedHoldings.length > 0 ? processedHoldings.reduce((worst, current) => (current.pnl < worst.pnl ? current : worst), processedHoldings[0]) : {pnl: 0, symbol: 'N/A'};
            
            const totalInvestmentForChart = portfolioSummary.totalInvestment;
            const pieData = holdings.map(h => ({
                symbol: h.symbol,
                name: h.name, // Keep full name for tooltip/internal use
                displayName: `${h.symbol} (${h.name.length > 15 ? h.name.substring(0, 12) + '...' : h.name})`,
                value: (h.quantity || 0) * (h.purchasePrice || 0),
                percentage: totalInvestmentForChart > 0 ? (((h.quantity || 0) * (h.purchasePrice || 0)) / totalInvestmentForChart) * 100 : 0
            })).filter(item => item.value > 0).sort((a,b) => b.value - a.value); 

            const SvgPieChart = ({ data, size = 250 }) => {
                if (!data || data.length === 0) return <p className="text-center text-slate-400 py-8">Not enough data for chart.</p>;
                const radius = size / 2.8; 
                const cx = size / 2;
                const cy = size / 2;
                let accumulatedAngle = -Math.PI / 2; 
                const colors = ['#0ea5e9', '#6366f1', '#8b5cf6', '#ec4899', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4'];
                
                return (
                    <div className="chart-container my-6 relative flex flex-col items-center">
                        <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
                            {data.map((slice, index) => {
                                const angle = (slice.percentage / 100) * 2 * Math.PI;
                                const x1 = cx + radius * Math.cos(accumulatedAngle);
                                const y1 = cy + radius * Math.sin(accumulatedAngle);
                                accumulatedAngle += angle;
                                const x2 = cx + radius * Math.cos(accumulatedAngle);
                                const y2 = cy + radius * Math.sin(accumulatedAngle);
                                const largeArcFlag = angle > Math.PI ? 1 : 0;
                                const pathData = `M ${cx},${cy} L ${x1},${y1} A ${radius},${radius} 0 ${largeArcFlag} 1 ${x2},${y2} Z`;
                                
                                return (
                                    <path 
                                        key={slice.symbol} 
                                        d={pathData} 
                                        fill={colors[index % colors.length]} 
                                        className="pie-chart-slice"
                                    />
                                );
                            })}
                        </svg>
                         <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 w-full max-w-xl"> {/* Adjusted grid for better spacing */}
                            {data.map((slice, index) => (
                                <div key={slice.symbol} className="flex items-center text-sm">
                                    <span className="inline-block w-3.5 h-3.5 mr-2.5 rounded-sm flex-shrink-0" style={{ backgroundColor: colors[index % colors.length] }}></span>
                                    <span className="text-slate-300" title={`${slice.symbol} (${slice.name}): ${slice.percentage.toFixed(1)}%`}>
                                        {slice.displayName}: <span className="font-medium text-slate-100">{slice.percentage.toFixed(1)}%</span>
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const SvgStockPerformanceBarChart = ({ data, width = 500, height = 350 }) => {
                const [tooltip, setTooltip] = useState({ visible: false, content: '', x: 0, y: 0 });

                if (!data || data.length === 0) {
                    return <p className="text-center text-slate-400 py-8">No holdings to display P/L.</p>;
                }
            
                const sortedData = [...data].sort((a, b) => a.symbol.localeCompare(b.symbol));
            
                const padding = { top: 20, right: 20, bottom: 70, left: 70 }; // Increased bottom for rotated labels
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
            
                const barGroupWidth = chartWidth / sortedData.length;
                const barWidth = Math.max(5, barGroupWidth * 0.35);
                const barSpacing = barGroupWidth * 0.1; // Space between two bars of a group
            
                const allValues = sortedData.flatMap(item => [item.investment, item.pnl]);
                const maxValue = Math.max(0, ...allValues.filter(v => v > 0));
                const minValue = Math.min(0, ...allValues.filter(v => v < 0));
            
                const yRange = maxValue - minValue === 0 ? 1 : maxValue - minValue;
                const yScale = (value) => padding.top + chartHeight - ((value - minValue) / yRange) * chartHeight;
                const zeroLineY = yScale(0);

                const handleMouseOver = (e, item, type) => {
                    const value = type === 'investment' ? item.investment : item.pnl;
                    setTooltip({
                        visible: true,
                        content: `${item.symbol} (${item.name}) - ${type === 'investment' ? 'Invested' : 'P/L'}: ${formatCurrency(value)}`,
                        x: e.pageX, 
                        y: e.pageY - 10 // Position above cursor
                    });
                };
                const handleMouseOut = () => {
                    setTooltip({ visible: false, content: '', x: 0, y: 0 });
                };
            
                return (
                    <div className="chart-container my-6 relative">
                        <svg width={width} height={height} viewBox={`0 0 ${width} ${height}`}>
                            {/* Y-axis Grid Lines and Labels */}
                            {Array.from({ length: 6 }).map((_, i) => {
                                const value = minValue + (i / 5) * yRange;
                                const y = yScale(value);
                                return (
                                    <g key={`y-grid-${i}`}>
                                        <line x1={padding.left} y1={y} x2={padding.left + chartWidth} y2={y} className="bar-graph-grid-line" />
                                        <text x={padding.left - 8} y={y} dy="0.35em" textAnchor="end" className="bar-graph-text">{formatCurrency(value)}</text>
                                    </g>
                                );
                            })}
                            {/* Zero line (thicker) */}
                            <line x1={padding.left} y1={zeroLineY} x2={padding.left + chartWidth} y2={zeroLineY} className="bar-graph-axis" strokeWidth="1.5" />
            
                            {sortedData.map((item, index) => {
                                const groupX = padding.left + index * barGroupWidth + (barGroupWidth - (barWidth * 2 + barSpacing)) / 2;
                                
                                const investmentBarHeight = item.investment > 0 ? Math.abs(zeroLineY - yScale(item.investment)) : 0;
                                const investmentBarY = item.investment > 0 ? yScale(item.investment) : zeroLineY;

                                const pnlBarHeight = Math.abs(zeroLineY - yScale(item.pnl));
                                const pnlBarY = item.pnl >= 0 ? yScale(item.pnl) : zeroLineY;
                                const pnlFillColor = item.pnl >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
            
                                return (
                                    <g key={item.symbol} transform={`translate(${groupX}, 0)`}>
                                        <rect
                                            x={0} y={investmentBarY} width={barWidth} height={investmentBarHeight}
                                            fill="rgba(59, 130, 246, 0.7)" className="bar-graph-bar"
                                            onMouseOver={(e) => handleMouseOver(e, item, 'investment')} onMouseOut={handleMouseOut}
                                        />
                                        <rect
                                            x={barWidth + barSpacing} y={pnlBarY} width={barWidth} height={pnlBarHeight}
                                            fill={pnlFillColor} className="bar-graph-bar"
                                            onMouseOver={(e) => handleMouseOver(e, item, 'pnl')} onMouseOut={handleMouseOut}
                                        />
                                        <text 
                                            x={(barWidth * 2 + barSpacing) / 2} 
                                            y={padding.top + chartHeight + 15} 
                                            textAnchor="middle" 
                                            className="bar-graph-text fill-slate-300"
                                            transform={`rotate(-45 ${(barWidth * 2 + barSpacing) / 2} ${padding.top + chartHeight + 15})`}
                                        >
                                            {item.symbol}
                                        </text>
                                    </g>
                                );
                            })}
                        </svg>
                        {tooltip.visible && (
                            <div className="tooltip" style={{ left: tooltip.x, top: tooltip.y, opacity: 1, transform: `translate(15px, -25px)` }}>
                                {tooltip.content}
                            </div>
                        )}
                         <div className="mt-4 flex justify-center space-x-4 text-sm">
                            <div className="flex items-center"><span className="w-3 h-3 bg-blue-500/70 mr-2 rounded-sm"></span>Invested</div>
                            <div className="flex items-center"><span className="w-3 h-3 bg-green-500/70 mr-2 rounded-sm"></span>Profit</div>
                            <div className="flex items-center"><span className="w-3 h-3 bg-red-500/70 mr-2 rounded-sm"></span>Loss</div>
                        </div>
                    </div>
                );
            };


            return (
                <div className="space-y-8 animate-fadeIn">
                    <h2 className="text-3xl font-semibold text-sky-400 border-b border-slate-700 pb-3">Portfolio Dashboard</h2>
                    
                    <div className="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                        <h3 className="text-xl font-semibold text-slate-200 mb-4">Overall Performance</h3>
                        <PortfolioSummaryCards summary={portfolioSummary} />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                            <h3 className="text-xl font-semibold text-slate-200 mb-4">Key Statistics</h3>
                            <div className="space-y-3 text-slate-300">
                                <p>Total Holdings: <span className="font-semibold text-sky-400 text-lg">{holdings.length}</span> unique stocks</p>
                                {bestPerformer.symbol !== 'N/A' && <p>Best Performer (P/L): <span className="font-semibold text-green-400">{bestPerformer.symbol} ({formatCurrency(bestPerformer.pnl)})</span></p>}
                                {worstPerformer.symbol !== 'N/A' && <p>Worst Performer (P/L): <span className="font-semibold text-red-400">{worstPerformer.symbol} ({formatCurrency(worstPerformer.pnl)})</span></p>}
                            </div>
                        </div>
                        <div className="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                            <h3 className="text-xl font-semibold text-slate-200 mb-2">Investment Distribution</h3>
                            <p className="text-sm text-slate-400 mb-4">Allocation of total investment by stock.</p>
                            <SvgPieChart data={pieData} />
                        </div>
                    </div>
                     <div className="bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
                        <h3 className="text-xl font-semibold text-slate-200 mb-2">Stock Investment vs. P/L</h3>
                        <p className="text-sm text-slate-400 mb-4">Invested amount and current Profit/Loss for each stock.</p>
                        <SvgStockPerformanceBarChart data={processedHoldings} />
                    </div>
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root')); 
        root.render(<App />);

    </script>
</body>
</html>
